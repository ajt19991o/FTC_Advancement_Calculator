<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DECODE Advancement Calculator ‚Ä¢ FTC Scout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .input-field { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin-top: 4px; outline: none; transition: border-color 0.2s; font-size: 0.875rem; }
        .input-field:focus { border-color: #6366f1; ring: 2px solid #6366f1; }
        .btn-scout { background-color: #6366f1; color: white; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.2s; }
        .btn-scout:hover { background-color: #4f46e5; transform: translateY(-1px); }
        .btn-scout:disabled { opacity: 0.6; cursor: not-allowed; }
        .probability-bar { height: 10px; border-radius: 5px; background: #e2e8f0; overflow: hidden; margin-top: 8px; }
        .probability-fill { height: 100%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #6366f1; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 italic tracking-tight">FTC SCOUT <span class="text-indigo-600">ADVANCEMENT</span></h1>
            <p class="text-slate-500 mt-2 font-medium">DECODE‚Ñ¢ 2025-2026 Season Performance Analysis</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Column 1: Sync & Context -->
            <div class="space-y-6">
                <!-- FTC Scout Sync -->
                <div class="card p-6 border-l-4 border-indigo-500">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="mr-2">üîç</span> Sync with FTC Scout
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Team Number</label>
                            <input type="number" id="scoutTeam" placeholder="e.g. 12345" class="input-field">
                        </div>
                        <button onclick="fetchScoutData()" id="fetchBtn" class="btn-scout w-full text-sm mt-2 flex items-center justify-center">
                            Sync Latest Results
                        </button>
                        <p class="text-[10px] text-slate-400 text-center">Uses FTC Scout GraphQL API ‚Ä¢ No Key Required</p>
                    </div>
                </div>

                <!-- Event Context -->
                <div class="card p-6 border-l-4 border-slate-400">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="mr-2">üåç</span> Event Context
                    </h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Adv. Slots</label>
                                <input type="number" id="advancementSlots" value="4" min="1" class="input-field" oninput="calculate()">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Difficulty</label>
                                <select id="regionWeight" class="input-field" onchange="calculate()">
                                    <option value="1.0">Standard</option>
                                    <option value="0.8">Competitive (TX, CA, MI)</option>
                                    <option value="1.2">Low-Density</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Total Teams</label>
                                <input type="number" id="totalTeams" value="28" min="1" class="input-field" oninput="calculate()">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Alliances</label>
                                <select id="numAlliances" class="input-field" onchange="calculate()">
                                    <option value="4">4 Alliances</option>
                                    <option value="8">8 Alliances</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2: Points Input -->
            <div class="space-y-6">
                <div class="card p-6 border-l-4 border-blue-500">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="mr-2">üìä</span> Qualification & Alliance
                    </h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Final Rank</label>
                                <input type="number" id="rank" value="1" min="1" class="input-field" oninput="calculate()">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Role</label>
                                <select id="allianceRole" class="input-field" onchange="calculate()">
                                    <option value="none">No Playoff</option>
                                    <option value="lead">Alliance Lead</option>
                                    <option value="draft">Drafted Team</option>
                                </select>
                            </div>
                        </div>
                        <div id="selectionOrderDiv" class="hidden">
                            <label class="text-xs font-bold text-slate-500 uppercase" id="orderLabel">Order (1-12)</label>
                            <input type="number" id="selectionOrder" value="1" min="1" max="24" class="input-field" oninput="calculate()">
                        </div>
                    </div>
                </div>

                <div class="card p-6 border-l-4 border-red-500">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="mr-2">‚öîÔ∏è</span> Playoff Outcome
                    </h2>
                    <select id="playoffFinish" class="input-field" onchange="calculate()">
                        <option value="0">Eliminated early</option>
                        <option value="5">4th Place (5 pts)</option>
                        <option value="10">3rd Place (10 pts)</option>
                        <option value="20">Finalists (20 pts)</option>
                        <option value="40">Event Winners (40 pts)</option>
                    </select>
                </div>

                <div class="card p-6 border-l-4 border-yellow-500">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <span class="mr-2">ü•á</span> Highest Judged Award
                    </h2>
                    <select id="judgedAward" class="input-field" onchange="calculate()">
                        <option value="0">No Judged Award</option>
                        <option value="60">Inspire Award - 1st (60 pts)</option>
                        <option value="30">Inspire Award - 2nd (30 pts)</option>
                        <option value="15">Inspire Award - 3rd (15 pts)</option>
                        <option value="12">Judged Award - 1st (12 pts)</option>
                        <option value="6">Judged Award - 2nd (6 pts)</option>
                        <option value="3">Judged Award - 3rd (3 pts)</option>
                    </select>
                </div>
            </div>

            <!-- Column 3: Results Display -->
            <div class="space-y-6">
                <div class="card p-8 bg-slate-900 text-white sticky top-8">
                    <div class="text-center mb-6">
                        <p class="text-slate-400 uppercase tracking-widest text-[10px] font-bold">Total Advancement Points</p>
                        <div class="text-7xl font-bold mt-2 text-indigo-400" id="totalPoints">0</div>
                    </div>

                    <div class="space-y-3 mb-8 border-y border-slate-800 py-4">
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Qual Performance</span>
                            <span id="ptsQual" class="font-bold">0 pts</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Alliance Selection</span>
                            <span id="ptsAlliance" class="font-bold">0 pts</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Playoff Advancement</span>
                            <span id="ptsPlayoff" class="font-bold">0 pts</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Judged Awards</span>
                            <span id="ptsAwards" class="font-bold">0 pts</span>
                        </div>
                    </div>

                    <div id="chanceCard" class="p-5 rounded-lg bg-slate-800 border border-slate-700">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-bold text-indigo-300 text-sm">Advancement Prob.</h3>
                            <span id="probabilityPercent" class="text-xl font-bold text-white">0%</span>
                        </div>
                        <div class="probability-bar">
                            <div id="probabilityFill" class="probability-fill" style="width: 0%"></div>
                        </div>
                        <p id="chanceText" class="text-[11px] leading-relaxed text-slate-400 mt-4">
                            Sync your data or enter stats manually to see results.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function fetchScoutData() {
            const teamNumber = document.getElementById('scoutTeam').value;
            const btn = document.getElementById('fetchBtn');

            if (!teamNumber) {
                alert("Please enter a Team Number.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> Syncing...`;

            const query = `
                query TeamLatestEvent($teamNumber: Int!) {
                    team(number: $teamNumber) {
                        events(season: 2025) {
                            event {
                                code
                                teams { teamNumber }
                                rankings { teamNumber rank }
                                awards { 
                                    type 
                                    placement 
                                    recipientTeams { teamNumber }
                                }
                            }
                        }
                    }
                }
            `;

            try {
                const response = await fetch('https://api.ftcscout.org/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, variables: { teamNumber: parseInt(teamNumber) } })
                });

                const result = await response.json();
                const teamData = result?.data?.team;
                
                if (!teamData || !teamData.events.length) throw new Error("No data found.");

                const latestEvent = teamData.events[teamData.events.length - 1].event;
                document.getElementById('totalTeams').value = latestEvent.teams.length;
                
                // Auto-toggle alliance count based on event size
                document.getElementById('numAlliances').value = latestEvent.teams.length >= 40 ? "8" : "4";

                const myRank = latestEvent.rankings.find(r => r.teamNumber === parseInt(teamNumber))?.rank;
                if (myRank) document.getElementById('rank').value = myRank;

                const myAward = latestEvent.awards.find(a => 
                    a.recipientTeams.some(t => t.teamNumber === parseInt(teamNumber))
                );

                if (myAward) {
                    const type = myAward.type.toLowerCase();
                    const place = myAward.placement;
                    if (type === 'inspire') {
                        document.getElementById('judgedAward').value = (place === 1) ? 60 : (place === 2 ? 30 : 15);
                    } else if (['think','connect','reach','sustain','design','innovate','control'].includes(type)) {
                        document.getElementById('judgedAward').value = (place === 1) ? 12 : (place === 2 ? 6 : 3);
                    }
                }

                calculate();
                btn.innerHTML = "Sync Success!";
                setTimeout(() => { btn.innerHTML = "Sync Latest Results"; btn.disabled = false; }, 2000);

            } catch (err) {
                btn.innerHTML = "Sync Failed";
                btn.disabled = false;
            }
        }

        function calculateQualPoints(rank, totalTeams) {
            if (rank <= 1) return 16;
            if (rank >= totalTeams) return 2;
            const normalizedRank = (rank - 0.5) / totalTeams;
            let pts = 16 - (14 * normalizedRank);
            return Math.max(2, Math.min(16, Math.round(pts)));
        }

        function calculate() {
            const rank = parseInt(document.getElementById('rank').value) || 1;
            const total = parseInt(document.getElementById('totalTeams').value) || 28;
            const alliances = parseInt(document.getElementById('numAlliances').value) || 4;
            const slots = parseInt(document.getElementById('advancementSlots').value) || 4;
            const role = document.getElementById('allianceRole').value;
            const order = parseInt(document.getElementById('selectionOrder').value) || 1;
            const playoffPts = parseInt(document.getElementById('playoffFinish').value) || 0;
            const awardPts = parseInt(document.getElementById('judgedAward').value) || 0;
            const regWeight = parseFloat(document.getElementById('regionWeight').value) || 1.0;

            const qualPts = calculateQualPoints(rank, total);
            
            let alliancePts = 0;
            const div = document.getElementById('selectionOrderDiv');
            if (role === 'none') {
                div.classList.add('hidden');
            } else {
                div.classList.remove('hidden');
                const maxOrder = alliances * (role === 'lead' ? 1 : 2);
                document.getElementById('orderLabel').innerText = role === 'lead' ? `Lead # (1-${alliances})` : `Pick # (1-${alliances * 2})`;
                
                // Formula: 21 - Selection Number
                alliancePts = Math.max(1, 21 - order);
                
                // Cap order based on number of alliances
                if (role === 'lead' && order > alliances) alliancePts = 21 - alliances;
            }

            const totalScore = qualPts + alliancePts + playoffPts + awardPts;

            document.getElementById('totalPoints').innerText = totalScore;
            document.getElementById('ptsQual').innerText = qualPts + " pts";
            document.getElementById('ptsAlliance').innerText = alliancePts + " pts";
            document.getElementById('ptsPlayoff').innerText = playoffPts + " pts";
            document.getElementById('ptsAwards').innerText = awardPts + " pts";

            let probability = 0;
            let statusMessage = "";

            if (awardPts === 60) {
                probability = 100;
                statusMessage = "<strong>Locked In.</strong> 1st Place Inspire is the #1 criteria. Congrats!";
            } else {
                let baseThreshold = (92 - (slots * 3.8)) / regWeight; 
                probability = Math.min(99, Math.max(0, (totalScore / baseThreshold) * 100));
                
                if (probability >= 85) statusMessage = "<strong>Very Likely.</strong> Your point total should comfortably clear the advancement cutoff.";
                else if (probability >= 50) statusMessage = "<strong>Competitive.</strong> You are on the bubble. Tiebreakers (awards/playoffs) will matter.";
                else statusMessage = "<strong>Low Probability.</strong> You likely need to move up in Judging or reach the Finals to advance.";
            }

            const probFill = document.getElementById('probabilityFill');
            probFill.style.width = probability + "%";
            document.getElementById('probabilityPercent').innerText = Math.round(probability) + "%";
            
            if (probability > 75) probFill.style.backgroundColor = "#6366f1"; 
            else if (probability > 40) probFill.style.backgroundColor = "#eab308"; 
            else probFill.style.backgroundColor = "#ef4444"; 
            
            document.getElementById('chanceText').innerHTML = statusMessage;
        }

        window.onload = calculate;
    </script>
</body>
</html>
