<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DECODE Advancement Calculator ‚Ä¢ FTC Scout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@500&display=swap');
        
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Theme Definitions*/
        .theme-scout { --primary: #6366f1; --primary-hover: #4f46e5; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --accent: #818cf8; }
        .theme-decode { --primary: #fbbf24; --primary-hover: #f59e0b; --bg: #111827; --card: #1f2937; --text: #f3f4f6; --accent: #fbbf24; }
        .theme-midnight { --primary: #0ea5e9; --primary-hover: #0284c7; --bg: #030712; --card: #111827; --text: #f8fafc; --accent: #38bdf8; }

        body.theme-scout { background-color: var(--bg); color: var(--text); }
        body.theme-decode { background-color: var(--bg); color: var(--text); }
        body.theme-midnight { background-color: var(--bg); color: var(--text); }

        .card { background-color: var(--card); border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid rgba(0,0,0,0.05); }
        body.theme-decode .card, body.theme-midnight .card { border-color: rgba(255,255,255,0.1); }

        .input-field { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin-top: 4px; outline: none; transition: all 0.2s; font-size: 0.875rem; background: transparent; color: inherit; }
        body.theme-decode .input-field, body.theme-midnight .input-field { border-color: #374151; }
        .input-field:focus { border-color: var(--primary); ring: 2px solid var(--primary); }

        .btn-theme { background-color: var(--primary); color: #000; font-weight: 700; }
        body.theme-scout .btn-theme, body.theme-midnight .btn-theme { color: #fff; }

        .btn-scout { background-color: var(--primary); color: white; padding: 10px 16px; border-radius: 6px; font-weight: 600; transition: all 0.2s; }
        body.theme-decode .btn-scout { color: #000; }
        .btn-scout:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .probability-bar { height: 10px; border-radius: 5px; background: rgba(0,0,0,0.1); overflow: hidden; margin-top: 8px; }
        body.theme-decode .probability-bar, body.theme-midnight .probability-bar { background: rgba(255,255,255,0.1); }
        
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        #debugLog { display: none; margin-top: 2rem; padding: 1rem; background: #000; color: #0f0; border-radius: 8px; font-size: 10px; overflow-x: auto; }
    </style>
</head>
<body class="p-4 md:p-8 theme-scout" id="mainBody">
    <div class="max-w-5xl mx-auto">
        <!-- Theme Switcher -->
        <div class="flex justify-end mb-4 space-x-2">
            <button onclick="setTheme('scout')" class="px-3 py-1 rounded text-[10px] font-bold uppercase tracking-tighter bg-indigo-100 text-indigo-700 hover:bg-indigo-200">FTC Scout</button>
            <button onclick="setTheme('decode')" class="px-3 py-1 rounded text-[10px] font-bold uppercase tracking-tighter bg-amber-400 text-black hover:bg-amber-500">DECODE Gold</button>
            <button onclick="setTheme('midnight')" class="px-3 py-1 rounded text-[10px] font-bold uppercase tracking-tighter bg-slate-800 text-blue-400 hover:bg-slate-700">Midnight</button>
        </div>

        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold italic tracking-tight uppercase"><span id="headerBrand">FTC SCOUT</span> <span class="text-[var(--primary)]">ADVANCEMENT</span></h1>
            <p class="text-slate-500 mt-2 font-medium opacity-80">DECODE‚Ñ¢ 2025-2026 Season Performance Analysis</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Column 1: Sync & Context -->
            <div class="space-y-6">
                <div class="card p-6 border-l-4 border-[var(--primary)]">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <span class="mr-2">üîç</span> Sync Latest Data
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold uppercase opacity-60">Team Number</label>
                            <input type="number" id="scoutTeam" placeholder="e.g. 12345" class="input-field">
                        </div>
                        <button onclick="fetchScoutData()" id="fetchBtn" class="btn-scout w-full text-sm mt-2 flex items-center justify-center">
                            Sync via FTC Scout
                        </button>
                        <div id="syncStatus" class="text-[10px] text-center font-bold mt-1"></div>
                        <button onclick="toggleDebug()" class="w-full text-[9px] uppercase opacity-40 hover:opacity-100 text-center mt-2">Toggle Debug Log</button>
                    </div>
                </div>

                <div class="card p-6 border-l-4 border-slate-400">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <span class="mr-2">üåç</span> Event Context
                    </h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold uppercase opacity-60">Adv. Slots</label>
                                <input type="number" id="advancementSlots" value="4" min="1" class="input-field" oninput="calculate()">
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase opacity-60">Difficulty</label>
                                <select id="regionWeight" class="input-field" onchange="calculate()">
                                    <option value="1.0">Standard</option>
                                    <option value="0.8">Competitive</option>
                                    <option value="1.2">Low-Density</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold uppercase opacity-60">Total Teams</label>
                                <input type="number" id="totalTeams" value="28" min="1" class="input-field" oninput="calculate()">
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase opacity-60">Alliances</label>
                                <select id="numAlliances" class="input-field" onchange="calculate()">
                                    <option value="4">4 Alliances</option>
                                    <option value="8">8 Alliances</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 2: Points Input -->
            <div class="space-y-6">
                <div class="card p-6 border-l-4 border-blue-500">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <span class="mr-2">üìä</span> Qualification & Alliance
                    </h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold uppercase opacity-60">Final Rank</label>
                                <input type="number" id="rank" value="1" min="1" class="input-field" oninput="calculate()">
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase opacity-60">Role</label>
                                <select id="allianceRole" class="input-field" onchange="calculate()">
                                    <option value="none">No Playoff</option>
                                    <option value="lead">Alliance Lead</option>
                                    <option value="draft">Drafted Team</option>
                                </select>
                            </div>
                        </div>
                        <div id="selectionOrderDiv" class="hidden">
                            <label class="text-xs font-bold uppercase opacity-60" id="orderLabel">Order (1-12)</label>
                            <input type="number" id="selectionOrder" value="1" min="1" max="24" class="input-field" oninput="calculate()">
                        </div>
                    </div>
                </div>

                <div class="card p-6 border-l-4 border-red-500">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <span class="mr-2">‚öîÔ∏è</span> Playoff Outcome
                    </h2>
                    <select id="playoffFinish" class="input-field" onchange="calculate()">
                        <option value="0">Eliminated early</option>
                        <option value="5">4th Place (5 pts)</option>
                        <option value="10">3rd Place (10 pts)</option>
                        <option value="20">Finalists (20 pts)</option>
                        <option value="40">Event Winners (40 pts)</option>
                    </select>
                </div>

                <div class="card p-6 border-l-4 border-yellow-500">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <span class="mr-2">ü•á</span> Highest Judged Award
                    </h2>
                    <select id="judgedAward" class="input-field" onchange="calculate()">
                        <option value="0">No Judged Award</option>
                        <option value="60">Inspire Award - 1st (60 pts)</option>
                        <option value="30">Inspire Award - 2nd (30 pts)</option>
                        <option value="15">Inspire Award - 3rd (15 pts)</option>
                        <option value="12">Judged Award - 1st (12 pts)</option>
                        <option value="6">Judged Award - 2nd (6 pts)</option>
                        <option value="3">Judged Award - 3rd (3 pts)</option>
                    </select>
                </div>
            </div>

            <!-- Column 3: Results Display -->
            <div class="space-y-6">
                <div class="card p-8 bg-slate-900 text-white sticky top-8" id="resultCard">
                    <div class="text-center mb-6">
                        <p class="text-slate-400 uppercase tracking-widest text-[10px] font-bold">Total Advancement Points</p>
                        <div class="text-7xl font-bold mt-2 text-[var(--primary)] mono" id="totalPoints">0</div>
                    </div>

                    <div class="space-y-3 mb-8 border-y border-slate-800 py-4">
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Qual Performance</span>
                            <span id="ptsQual" class="font-bold">0 pts</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Alliance Selection</span>
                            <span id="ptsAlliance" class="font-bold">0 pts</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Playoff Advancement</span>
                            <span id="ptsPlayoff" class="font-bold">0 pts</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-400">Judged Awards</span>
                            <span id="ptsAwards" class="font-bold">0 pts</span>
                        </div>
                    </div>

                    <div class="p-5 rounded-lg bg-slate-800 border border-slate-700">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-bold text-slate-300 text-sm">Advancement Prob.</h3>
                            <span id="probabilityPercent" class="text-xl font-bold text-white mono">0%</span>
                        </div>
                        <div class="probability-bar">
                            <div id="probabilityFill" class="h-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <p id="chanceText" class="text-[11px] leading-relaxed text-slate-400 mt-4">
                            Calculated based on DECODE competition manual criteria.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <pre id="debugLog"></pre>
    </div>

    <script>
        function setTheme(theme) {
            const body = document.getElementById('mainBody');
            const brand = document.getElementById('headerBrand');
            body.className = 'p-4 md:p-8 theme-' + theme;
            brand.innerText = theme === 'decode' ? 'DECODE' : (theme === 'midnight' ? 'CORE' : 'FTC SCOUT');
            localStorage.setItem('ftcTheme', theme);
        }
        
        function toggleDebug() {
            const log = document.getElementById('debugLog');
            log.style.display = log.style.display === 'block' ? 'none' : 'block';
        }

        async function fetchScoutData() {
            const teamNumberInput = document.getElementById('scoutTeam').value;
            const btn = document.getElementById('fetchBtn');
            const status = document.getElementById('syncStatus');
            const debug = document.getElementById('debugLog');

            if (!teamNumberInput) {
                alert("Please enter a Team Number.");
                return;
            }

            const teamNumber = parseInt(teamNumberInput);
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> Syncing...`;
            status.innerHTML = "";
            status.className = "text-[10px] text-center font-bold mt-1 text-slate-400";

            // Cleaned GraphQL Query
            const query = `
                query TeamLatestEvent($teamNumber: Int!) {
                    teamByNumber(number: $teamNumber) {
                        number
                        events(season: 2025) {
                            rank
                            event {
                                code
                                name
                                teams { teamNumber }
                                awards { 
                                    type 
                                    placement 
                                    team { teamNumber }
                                }
                            }
                        }
                    }
                }
            `;

            try {
                const response = await fetch('https://api.ftcscout.org/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, variables: { teamNumber } })
                });

                const result = await response.json();
                debug.innerText = JSON.stringify(result, null, 2);

                if (result.errors) throw new Error("API Error: " + result.errors[0].message);

                const teamData = result?.data?.teamByNumber;
                if (!teamData) throw new Error("Team not found.");
                
                const validEvents = (teamData.events || []).filter(e => e.rank > 0);
                if (validEvents.length === 0) throw new Error("No recorded rankings found for this season.");

                // Use the most recent event
                const latestEntry = validEvents[validEvents.length - 1];
                const latestEvent = latestEntry.event;
                
                status.innerHTML = "Synced: " + latestEvent.name;
                status.classList.add("text-[var(--primary)]");

                document.getElementById('totalTeams').value = latestEvent.teams.length;
                document.getElementById('numAlliances').value = latestEvent.teams.length >= 40 ? "8" : "4";
                document.getElementById('rank').value = latestEntry.rank;

                // Award mapping
                const teamAwards = (latestEvent.awards || []).filter(a => 
                    a.team && a.team.teamNumber === teamNumber
                );

                if (teamAwards.length > 0) {
                    let bestScore = 0;
                    teamAwards.forEach(a => {
                        const type = a.type.toLowerCase();
                        const place = a.placement;
                        let score = 0;
                        if (type === 'inspire') {
                            score = (place === 1) ? 60 : (place === 2 ? 30 : 15);
                        } else if (['think','connect','reach','sustain','design','innovate','control'].includes(type)) {
                            score = (place === 1) ? 12 : (place === 2 ? 6 : 3);
                        }
                        if (score > bestScore) bestScore = score;
                    });
                    document.getElementById('judgedAward').value = bestScore;
                } else {
                    document.getElementById('judgedAward').value = "0";
                }

                calculate();
                btn.innerHTML = "Sync Success!";
                setTimeout(() => { btn.innerHTML = "Sync via FTC Scout"; btn.disabled = false; }, 2000);

            } catch (err) {
                status.innerHTML = "Sync Error: " + err.message;
                status.classList.add("text-red-500");
                btn.innerHTML = "Sync Failed";
                btn.disabled = false;
            }
        }

        function calculateQualPoints(rank, totalTeams) {
            if (rank <= 1) return 16;
            if (rank >= totalTeams) return 2;
            const normalizedRank = (rank - 0.5) / totalTeams;
            let pts = 16 - (14 * normalizedRank);
            return Math.max(2, Math.min(16, Math.round(pts)));
        }

        function calculate() {
            const rank = parseInt(document.getElementById('rank').value) || 1;
            const total = parseInt(document.getElementById('totalTeams').value) || 28;
            const alliances = parseInt(document.getElementById('numAlliances').value) || 4;
            const slots = parseInt(document.getElementById('advancementSlots').value) || 4;
            const role = document.getElementById('allianceRole').value;
            const order = parseInt(document.getElementById('selectionOrder').value) || 1;
            const playoffPts = parseInt(document.getElementById('playoffFinish').value) || 0;
            const awardPts = parseInt(document.getElementById('judgedAward').value) || 0;
            const regWeight = parseFloat(document.getElementById('regionWeight').value) || 1.0;

            const qualPts = calculateQualPoints(rank, total);
            
            let alliancePts = 0;
            const div = document.getElementById('selectionOrderDiv');
            if (role === 'none') {
                div.classList.add('hidden');
            } else {
                div.classList.remove('hidden');
                document.getElementById('orderLabel').innerText = role === 'lead' ? `Lead # (1-${alliances})` : `Pick # (1-${alliances * 2})`;
                alliancePts = Math.max(1, 21 - order);
                if (role === 'lead' && order > alliances) alliancePts = 21 - alliances;
            }

            const totalScore = qualPts + alliancePts + playoffPts + awardPts;

            document.getElementById('totalPoints').innerText = totalScore;
            document.getElementById('ptsQual').innerText = qualPts + " pts";
            document.getElementById('ptsAlliance').innerText = alliancePts + " pts";
            document.getElementById('ptsPlayoff').innerText = playoffPts + " pts";
            document.getElementById('ptsAwards').innerText = awardPts + " pts";

            let probability = 0;
            let statusMessage = "";

            if (awardPts === 60) {
                probability = 100;
                statusMessage = "<strong>Locked In.</strong> 1st Place Inspire is the highest advancement priority. Pack your bags!";
            } else {
                let baseThreshold = (92 - (slots * 3.8)) / regWeight; 
                probability = Math.min(99, Math.max(0, (totalScore / baseThreshold) * 100));
                
                if (probability >= 85) statusMessage = "<strong>Very Likely.</strong> Your point total should comfortably clear the cutoff.";
                else if (probability >= 50) statusMessage = "<strong>Bubble Team.</strong> Possible, but depends on other award winners.";
                else statusMessage = "<strong>Low Odds.</strong> Aim for a Judged Award to boost your points.";
            }

            const probFill = document.getElementById('probabilityFill');
            probFill.style.width = probability + "%";
            document.getElementById('probabilityPercent').innerText = Math.round(probability) + "%";
            
            if (probability > 75) probFill.style.backgroundColor = "var(--primary)"; 
            else if (probability > 40) probFill.style.backgroundColor = "#eab308"; 
            else probFill.style.backgroundColor = "#ef4444"; 
            
            document.getElementById('chanceText').innerHTML = statusMessage;
        }

        window.onload = () => {
            const saved = localStorage.getItem('ftcTheme');
            if (saved) setTheme(saved);
            calculate();
        };
    </script>
</body>
</html>
